<!-- IMSEGrapesOrder BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Tue Jun 17 15:49:00 EEST 2014 -->
<bpel:process name="IMSEGrapesOrder"
         targetNamespace="http://eclipse.org/bpel/sample"
         suppressJoinFailure="yes"
         xmlns:tns="http://eclipse.org/bpel/sample"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns1="http://www.w3.org/2001/XMLSchema" xmlns:ns="http://www.example.org/GrapesWSDL2/">

    <!-- Import the client WSDL -->
	<bpel:import location="IMSEGrapesOrderArtifacts.wsdl" namespace="http://eclipse.org/bpel/sample" 
	        importType="http://schemas.xmlsoap.org/wsdl/" />
         
    <!-- ================================================================= -->         
    <!-- PARTNERLINKS                                                      -->
    <!-- List of services participating in this BPEL process               -->
    <!-- ================================================================= -->         
    <bpel:partnerLinks>
        <!-- The 'client' role represents the requester of this service. -->
        <bpel:partnerLink name="client"
                     partnerLinkType="tns:IMSEGrapesOrder"
                     myRole="IMSEGrapesOrderProvider"
                     />
        <bpel:partnerLink name="GrapesCompanyOne" partnerLinkType="tns:IMSEGrapesOrderPT" partnerRole="IMSEGrapesPT"></bpel:partnerLink>
        <bpel:partnerLink name="GrapseProducerTwo" partnerLinkType="tns:GrapesProducerTwoPL" partnerRole="GrapesProducerTwoPTL"></bpel:partnerLink>
    </bpel:partnerLinks>
  
    <!-- ================================================================= -->         
    <!-- VARIABLES                                                         -->
    <!-- List of messages and XML documents used within this BPEL process  -->
    <!-- ================================================================= -->         
    <bpel:variables>
        <!-- Reference to the message passed as input during initiation -->
        <bpel:variable name="input"
                  messageType="tns:IMSEGrapesOrderRequestMessage"/>
                  
        <!-- 
          Reference to the message that will be returned to the requester
          -->
        <bpel:variable name="output"
                  messageType="tns:IMSEGrapesOrderResponseMessage"/>
        <bpel:variable name="orderid" type="ns1:int"></bpel:variable>
        <bpel:variable name="pricecompanyone" type="ns1:double"></bpel:variable>
        <bpel:variable name="pricecompanytwo" type="ns1:double"></bpel:variable>
        <bpel:variable name="selectedcomapny" type="ns1:int"></bpel:variable>
        <bpel:variable name="GrapesCompanyOneResponse" messageType="tns:confirmGrapesOrderResponse"></bpel:variable>
        <bpel:variable name="GrapesCompanyOneRequest" messageType="tns:confirmGrapesOrderRequest"></bpel:variable>
        <bpel:variable name="GrapesCompanyOneResponse1" messageType="tns:IMSEGrapesResponseMessage"></bpel:variable>
        <bpel:variable name="GrapesCompanyOneRequest1" messageType="tns:IMSEGrapesRequestMessage"></bpel:variable>
        <bpel:variable name="GrapseProducerTwoResponse" messageType="ns:CreateOrderResponse"></bpel:variable>
        <bpel:variable name="GrapseProducerTwoRequest" messageType="ns:CreateOrderRequest"></bpel:variable>
        <bpel:variable name="GrapseProducerTwoResponse1" messageType="ns:CheckOrderResponse"></bpel:variable>
        <bpel:variable name="GrapseProducerTwoRequest1" messageType="ns:CheckOrderRequest"></bpel:variable>
        <bpel:variable name="GrapesCompanyOneResponse2" messageType="tns:getInvoiceResponse"></bpel:variable>
        <bpel:variable name="GrapesCompanyOneRequest2" messageType="tns:getInvoiceRequest"></bpel:variable>
        <bpel:variable name="GrapseProducerTwoResponse2" messageType="ns:CancelOrderResponse"></bpel:variable>
        <bpel:variable name="GrapseProducerTwoRequest2" messageType="ns:CancelOrderRequest"></bpel:variable>
    </bpel:variables>

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:sequence name="main">
        
        <!-- Receive input from requester. 
             Note: This maps to operation defined in IMSEGrapesOrder.wsdl 
             -->
        <bpel:receive name="receiveGrapesOrderRequest" partnerLink="client"
                 portType="tns:IMSEGrapesOrder"
                 operation="ordergrapes" variable="input"
                 createInstance="yes"/>
        
        <!-- Generate reply to synchronous request -->
        <bpel:sequence name="Sequence">
            <bpel:flow name="Flow"><bpel:sequence name="GrapesProducerOne">
                    <bpel:assign validate="no" name="setOrderDetailsOne">
                    <bpel:copy>
                        <bpel:from><bpel:literal><tns:IMSEGrapesRequest xmlns:tns="http://eclipse.org/bpel/sample" xmlns:tns1="http://www.example.org/grapes" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:NewElement>
    <tns1:order>
      <tns1:order_id>0</tns1:order_id>
      <tns1:customer_id>0</tns1:customer_id>
      <tns1:status>0</tns1:status>
      <tns1:subtotal>0.0</tns1:subtotal>
      <tns1:shipping>0.0</tns1:shipping>
      <tns1:total>0.0</tns1:total>
    </tns1:order>
    <tns1:orderDetail>
      <tns1:order_id>0</tns1:order_id>
      <tns1:grapes_id>0</tns1:grapes_id>
      <tns1:quantity>0</tns1:quantity>
      <tns1:price>0.0</tns1:price>
    </tns1:orderDetail>
  </tns:NewElement>
</tns:IMSEGrapesRequest>
</bpel:literal></bpel:from>
                        <bpel:to variable="GrapesCompanyOneRequest1" part="payload"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="payload" variable="input">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:order]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="payload" variable="GrapesCompanyOneRequest1">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:NewElement]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                    <bpel:invoke name="GrapesProducerOneService" partnerLink="GrapesCompanyOne" operation="createGrapesOrder" portType="tns:IMSEGrapesPortType" inputVariable="GrapesCompanyOneRequest1" outputVariable="GrapesCompanyOneResponse1"></bpel:invoke>
                    <bpel:assign validate="no" name="setResults"><bpel:copy>
                        <bpel:from><bpel:literal xml:space="preserve"><tns:IMSEGrapesOrderResponse xmlns:tns="http://eclipse.org/bpel/sample" xmlns:tns1="http://www.example.org/grapes" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:status>0</tns:status>
  <tns:grapesproducerid>1</tns:grapesproducerid>
  <tns:order>
    <tns1:order_id>0</tns1:order_id>
    <tns1:customer_id>0</tns1:customer_id>
    <tns1:status>0</tns1:status>
    <tns1:subtotal>0.0</tns1:subtotal>
    <tns1:shipping>0.0</tns1:shipping>
    <tns1:total>0.0</tns1:total>
  </tns:order>
</tns:IMSEGrapesOrderResponse></bpel:literal></bpel:from>
                        <bpel:to variable="output" part="payload"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="payload" variable="GrapesCompanyOneResponse1">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:orderdetails]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="payload" variable="output">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:order]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                
                        
                    </bpel:assign>
                    
                </bpel:sequence><bpel:sequence name="GrapesProducerTwo">
                    <bpel:assign validate="no" name="setOrderDetailsOne">
                        <bpel:copy>
                            <bpel:from><bpel:literal><tns:CreateOrder xmlns:tns="http://www.example.org/GrapesWSDL2/" xmlns:tns1="http://www.example.org/grapes" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <order>
    <tns1:order>
      <tns1:order_id>0</tns1:order_id>
      <tns1:customer_id>0</tns1:customer_id>
      <tns1:status>0</tns1:status>
      <tns1:subtotal>0.0</tns1:subtotal>
      <tns1:shipping>0.0</tns1:shipping>
      <tns1:total>0.0</tns1:total>
    </tns1:order>
    <tns1:orderDetail>
      <tns1:order_id>0</tns1:order_id>
      <tns1:grapes_id>0</tns1:grapes_id>
      <tns1:quantity>0</tns1:quantity>
      <tns1:price>0.0</tns1:price>
    </tns1:orderDetail>
  </order>
</tns:CreateOrder>
</bpel:literal></bpel:from>
                            <bpel:to variable="GrapseProducerTwoRequest" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="payload" variable="input">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:order]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="GrapseProducerTwoRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="GrapesProducerTwoService" partnerLink="GrapseProducerTwo" operation="CreateOrder" portType="ns:GrapesWSDL2" inputVariable="GrapseProducerTwoRequest" outputVariable="GrapseProducerTwoResponse"></bpel:invoke>
                    <bpel:assign validate="no" name="setGetOrder">
                        <bpel:copy>
                            <bpel:from><bpel:literal><tns:CheckOrder xmlns:tns="http://www.example.org/GrapesWSDL2/" xmlns:tns1="http://www.example.org/grapes" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <order_id>0</order_id>
</tns:CheckOrder>
</bpel:literal></bpel:from>
                            <bpel:to variable="GrapseProducerTwoRequest1" part="parameters"></bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="parameters" variable="GrapseProducerTwoResponse">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order_id]]></bpel:query>
                            </bpel:from>
                            <bpel:to part="parameters" variable="GrapseProducerTwoRequest1">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order_id]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:invoke name="GrapesProducerTwoServiceGetOrder" partnerLink="GrapseProducerTwo" operation="CheckOrder" portType="ns:GrapesWSDL2" inputVariable="GrapseProducerTwoRequest1" outputVariable="GrapseProducerTwoResponse1"></bpel:invoke>
                </bpel:sequence></bpel:flow>
        
                
                
                
            
        </bpel:sequence>
        
        
        
        <bpel:if name="IfProducerOneCheaperThanTwo">
            <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[1<2]]></bpel:condition>
            <bpel:sequence>
                <bpel:flow name="Flow1"><bpel:sequence name="ConfirmOrderWithProducerOne">
                        
                        
                        <bpel:assign validate="no" name="setConfirmrequest">
                            <bpel:copy><bpel:from><bpel:literal><tns:confirmGrapesOrder xmlns:tns="http://eclipse.org/bpel/sample" xmlns:tns1="http://www.example.org/grapes" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:orderid>0</tns:orderid>
</tns:confirmGrapesOrder>
</bpel:literal></bpel:from>
                        <bpel:to variable="GrapesCompanyOneRequest" part="parameters"></bpel:to>
                    
                            </bpel:copy><bpel:copy>
                        <bpel:from part="payload" variable="GrapesCompanyOneResponse1">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:orderid]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="GrapesCompanyOneRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:orderid]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                
                        
                        </bpel:assign>
                        <bpel:invoke name="confirmOrder" partnerLink="GrapesCompanyOne" operation="confirmGrapesOrder" portType="tns:IMSEGrapesPortType" inputVariable="GrapesCompanyOneRequest" outputVariable="GrapesCompanyOneResponse"></bpel:invoke>
                        <bpel:assign validate="no" name="setGetInvoice"><bpel:copy>
                        <bpel:from><bpel:literal><tns:getInvoice xmlns:tns="http://eclipse.org/bpel/sample" xmlns:tns1="http://www.example.org/grapes" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <tns:orderid>0</tns:orderid>
</tns:getInvoice>
</bpel:literal></bpel:from>
                        <bpel:to variable="GrapesCompanyOneRequest2" part="parameters"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="payload" variable="GrapesCompanyOneResponse1">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:orderid]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="GrapesCompanyOneRequest2">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[tns:orderid]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                
                        </bpel:assign>
                        <bpel:invoke name="getInvoice" partnerLink="GrapesCompanyOne" operation="getInvoice" portType="tns:IMSEGrapesPortType" inputVariable="GrapesCompanyOneRequest2" outputVariable="GrapesCompanyOneResponse2"></bpel:invoke>
                        
                        <bpel:empty name="PrintInVoice"></bpel:empty>
                        <bpel:empty name="PayUsingBank"></bpel:empty>
                        <bpel:empty name="SendThePaymentDetails"></bpel:empty>
                    </bpel:sequence><bpel:sequence name="CancelOrderWithProducertwo">
                        
                        
                        <bpel:assign validate="no" name="setCancel">
                            <bpel:copy>
                                <bpel:from><bpel:literal><tns:CancelOrder xmlns:tns="http://www.example.org/GrapesWSDL2/" xmlns:tns1="http://www.example.org/grapes" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <order_id>0</order_id>
</tns:CancelOrder>
</bpel:literal></bpel:from>
                                <bpel:to variable="GrapseProducerTwoRequest2" part="parameters"></bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="parameters" variable="GrapseProducerTwoResponse">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order_id]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="parameters" variable="GrapseProducerTwoRequest2">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[order_id]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                        <bpel:invoke name="Cancel" partnerLink="GrapseProducerTwo" operation="CancelOrder" portType="ns:GrapesWSDL2" inputVariable="GrapseProducerTwoRequest2" outputVariable="GrapseProducerTwoResponse2"></bpel:invoke>
                    </bpel:sequence></bpel:flow>
                
                
                
                
            </bpel:sequence>
            <bpel:else>
                <bpel:sequence><bpel:flow name="Flow2"><bpel:sequence name="CancelOrderWithProducerOne">
                            <bpel:empty name="CancelOrder"></bpel:empty>
                            
                        </bpel:sequence><bpel:sequence name="ConfirmOrderWithProducerTwo">
                            <bpel:empty name="confirmOrderProducerTwo"></bpel:empty>
                            <bpel:empty name="DoPayment"></bpel:empty>
                        </bpel:sequence></bpel:flow>
                    
                    
                
                </bpel:sequence>
            </bpel:else>
        </bpel:if>
        
        <bpel:reply name="replyOutput" partnerLink="client" portType="tns:IMSEGrapesOrder" operation="ordergrapes" variable="output" />
        <bpel:empty name="RecieveCheckStatus"></bpel:empty>
    </bpel:sequence>
</bpel:process>

